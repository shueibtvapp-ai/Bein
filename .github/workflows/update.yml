name: Update YouTube Streams

permissions:
  contents: write

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install yt-dlp
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp

      - name: Extract streams and write files
        run: |
          python - <<'PY'
          import time
          from yt_dlp import YoutubeDL
          channels = [
            ("stream.txt", "https://www.youtube.com/live/2lJZPT6OljI"),
            ("bein_sports.txt", "https://www.youtube.com/live/Gxs7glumXMU")
          ]
          ydl_opts = {"quiet": True, "skip_download": True, "noplaylist": True, "format": "best"}
          with YoutubeDL(ydl_opts) as ydl:
              for filename, url in channels:
                  out = None
                  try:
                      info = ydl.extract_info(url, download=False)
                      formats = info.get("formats") or []
                      for f in formats:
                          furl = f.get("url") or ""
                          proto = str(f.get("protocol") or "").lower()
                          if "m3u8" in proto or ".m3u8" in furl or "manifest" in furl:
                              out = furl
                              break
                      if not out:
                          for f in formats:
                              if f.get("url"):
                                  out = f.get("url")
                                  break
                      if not out:
                          out = info.get("url")
                  except Exception:
                      out = None
                  if out is None:
                      try:
                          with open(filename, "r") as rf:
                              for line in rf:
                                  if line.strip().startswith("http"):
                                      out = line.strip()
                                      break
                      except Exception:
                          out = ""
                  try:
                      with open(filename, "w") as fh:
                          if out:
                              fh.write(out.strip() + "\n")
                          else:
                              fh.write("\n")
                          fh.write(str(int(time.time())) + "\n")
                  except Exception:
                      pass
          PY

      - name: Commit and push
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "github-action"
          git add stream.txt bein_sports.txt || true
          git commit -m "auto update streams $(date +%s)" || true
          git push || true
