name: Update YouTube Streams

permissions:
  contents: write

on:
  schedule:
    - cron: "0 */3 * * *" # يعمل تلقائياً كل 3 ساعات
  workflow_dispatch: # يسمح لك بتشغيله يدوياً في أي وقت

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install yt-dlp
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp

      - name: Extract streams
        run: |
          python - <<'PY'
          import sys
          import os
          from yt_dlp import YoutubeDL
          
          # قائمة القنوات: (اسم الملف الذي سيتم حفظ الرابط فيه ، رابط اليوتيوب)
          channels = [
              ("stream.txt", "https://www.youtube.com/live/2lJZPT6OljI"),        # beIN SPORTS NEWS
              ("bein_sports.txt", "https://www.youtube.com/live/Gxs7glumXMU")    # beIN SPORTS المفتوحة
          ]
          
          ydl_opts = {
              "quiet": True, 
              "skip_download": True, 
              "noplaylist": True,
              "format": "best"
          }
          
          for filename, url in channels:
              print(f"جاري استخراج الرابط لـ: {filename}...")
              try:
                  with YoutubeDL(ydl_opts) as ydl:
                      info = ydl.extract_info(url, download=False)
                      
                  out = None
                  if info:
                      formats = info.get("formats") or []
                      # البحث عن رابط m3u8 (HLS)
                      for f in formats:
                          furl = f.get("url") or ""
                          proto = str(f.get("protocol") or "").lower()
                          if "m3u8" in proto or ".m3u8" in furl:
                              out = furl
                              break
                      
                      # إذا لم يجد m3u8 يبحث عن أي رابط متاح
                      if not out:
                          for f in formats:
                              if f.get("url"):
                                  out = f.get("url")
                                  break
                                  
                      if not out:
                          out = info.get("url")

                  if out:
                      with open(filename, "w") as fh:
                          fh.write(out.strip())
                      print(f"تم تحديث {filename} بنجاح.")
                  else:
                      print(f"فشل العثور على رابط لـ {filename}")

              except Exception as e:
                  print(f"حدث خطأ أثناء معالجة {url}: {e}")
          PY

      - name: Commit and Push update
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "github-action"
          git add stream.txt bein_sports.txt
          git commit -m "تحديث تلقائي لروابط القنوات" || echo "لا توجد تغييرات للمزامنة"
          git push
