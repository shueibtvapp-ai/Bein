name: Update YouTube Streams

permissions:
  contents: write

on:
  schedule:
    - cron: "0 */3 * * *" # يعمل تلقائياً كل 3 ساعات
  workflow_dispatch: # يسمح لك بتشغيله يدوياً في أي وقت

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install yt-dlp
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp

      - name: Extract streams
        run: |
          python - <<'PY'
          import sys
          from yt_dlp import YoutubeDL

          # قائمة القنوات: (اسم الملف الذي سيتم حفظ الرابط فيه ، رابط اليوتيوب)
          channels = [
              ("stream.txt", "https://www.youtube.com/live/2lJZPT6OljI"),        # beIN SPORTS NEWS
              ("bein_sports.txt", "https://www.youtube.com/live/Gxs7glumXMU")    # beIN SPORTS المفتوحة
          ]

          ydl_opts = {
              "quiet": True,
              "skip_download": True,
              "noplaylist": True,
              "format": "best",
              # اختياري: تحسين استخراج روابط يوتيوب لجلب روابط موبايل/Android إن لزم
              # "extractor_args": {"youtube": {"player_client": ["android"]}}
          }

          for filename, url in channels:
              print(f"جاري استخراج الرابط لـ: {filename} من {url} ...")
              try:
                  with YoutubeDL(ydl_opts) as ydl:
                      info = ydl.extract_info(url, download=False)
              except Exception as e:
                  print(f"خطأ في yt-dlp عند معالجة {url}: {e}")
                  continue

              out = None
              if info:
                  formats = info.get("formats") or []
                  # البحث عن رابط m3u8 (HLS) أولاً
                  for f in formats:
                      furl = f.get("url") or ""
                      proto = str(f.get("protocol") or "").lower()
                      if "m3u8" in proto or ".m3u8" in furl or "manifest" in furl:
                          out = furl
                          break

                  # fallback: أي رابط متاح
                  if not out:
                      for f in formats:
                          if f.get("url"):
                              out = f.get("url")
                              break

                  if not out:
                      out = info.get("url")

              if out:
                  try:
                      with open(filename, "w") as fh:
                          fh.write(out.strip())
                      print(f"تم تحديث {filename} بنجاح.")
                  except Exception as e:
                      print(f"خطأ في كتابة {filename}: {e}")
              else:
                  print(f"فشل العثور على رابط صالح لـ {filename}")
          PY

      - name: Commit and Push update (safe)
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "github-action"

          # أضف الملفات التي نريد تحديثها (تغير هذا لو أسماء الملفات تختلف)
          git add stream.txt bein_sports.txt || true

          # إذا لا توجد تغييرات مجمعة (staged) نخرج بدون خطأ
          if git diff --cached --quiet; then
            echo "لا توجد تغييرات للمزامنة"
            exit 0
          fi

          # وإلا قم بالـ commit + push
          git commit -m "تحديث تلقائي لروابط القنوات"
          git push
