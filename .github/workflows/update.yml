name: Update YouTube Streams

permissions:
  contents: write

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install yt-dlp
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp

      - name: Extract m3u8 streams and write files
        run: |
          python - <<'PY'
          from yt_dlp import YoutubeDL

          channels = [
            ("stream.txt", "https://www.youtube.com/live/2lJZPT6OljI"),
            ("bein_sports.txt", "https://www.youtube.com/live/Gxs7glumXMU")
          ]

          ydl_opts = {
              "quiet": True,
              "skip_download": True,
              "noplaylist": True,
              "format": "best"
          }

          def find_m3u8_from_info(info):
              # search formats for HLS manifests
              for f in info.get("formats", []) or []:
                  url = f.get("url") or ""
                  proto = str(f.get("protocol") or "").lower()
                  ext = str(f.get("ext") or "").lower()
                  # common indicators for HLS manifest
                  if ext == "m3u8" or "m3u8" in proto or ".m3u8" in url or "manifest" in url:
                      return url
              # fallback: sometimes info.url points to a manifest
              url = info.get("url") or ""
              if url and (".m3u8" in url or "manifest" in url):
                  return url
              # try thumbnails or formats' manifest_url fields if present
              for f in info.get("formats", []) or []:
                  m = f.get("manifest_url") or f.get("manifest") or ""
                  if m and (".m3u8" in m or "manifest" in m):
                      return m
              return None

          with YoutubeDL(ydl_opts) as ydl:
              for filename, yt_url in channels:
                  m3u8 = None
                  try:
                      info = ydl.extract_info(yt_url, download=False)
                      if info:
                          m3u8 = find_m3u8_from_info(info)
                  except Exception as e:
                      # extraction error - keep m3u8 as None
                      m3u8 = None

                  # if we didn't find a new m3u8, try to preserve existing file content (if any)
                  if not m3u8:
                      try:
                          with open(filename, "r") as rf:
                              for line in rf:
                                  line = line.strip()
                                  if line.startswith("http") and (".m3u8" in line or "manifest" in line or "googlevideo.com" in line):
                                      m3u8 = line
                                      break
                      except Exception:
                          m3u8 = ""

                  # ensure file always contains either the found m3u8 or empty line
                  try:
                      with open(filename, "w") as wf:
                          if m3u8:
                              wf.write(m3u8.strip() + "\n")
                          else:
                              wf.write("\n")
                  except Exception:
                      pass
          PY

      - name: Commit and push
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "github-action"
          git add stream.txt bein_sports.txt || true
          git commit -m "auto update m3u8 streams $(date -u +%s)" --allow-empty || true
          git push || true
